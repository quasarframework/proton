# Copyright 2019-2024 Tauri Programme within The Commons Conservancy
# SPDX-License-Identifier: Apache-2.0
# SPDX-License-Identifier: MIT

name: Build EXE for TestDriver
env:
  DEBUG: napi:*

on:
  pull_request:

jobs:
  build:
    name: build windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - run: corepack enable
      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          architecture: x64
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc
      - name: Install dependencies
        run: pnpm i --frozen-lockfile --ignore-scripts
      - name: Build CLI
        run: pnpm run build:cli
        shell: bash
      - name: Build API
        run: pnpm run build:api
        shell: bash
      - name: Install dependencies for API Example App
        run: |
          cd examples/api
          pnpm i
      - name: Build API Example App
        run: |
          cd examples/api
          pnpm tauri build
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bindings-x86_64-pc-windows-msvc
          path: examples/api/src-tauri/target/release/app.exe
          if-no-files-found: error
      - uses: testdriverai/action@main
        with:
          key: ${{ secrets.TESTDRIVER_API_KEY }}
          prompt: | 
            1. Click around the desktop app 
          prerun: |
            $headers = @{
                Authorization = "token ${{ secrets.GITHUB_TOKEN }}"
            }
            $downloadFolder = "./download"
            $artifactFileName = "app.exe"
            $artifactFilePath = "$downloadFolder/$artifactFileName"
            Write-Host "Starting the artifact download process..."
            
            # Create the download directory if it doesn't exist
            if (-not (Test-Path -Path $downloadFolder)) {
                Write-Host "Creating download folder..."
                mkdir $downloadFolder
            } else {
                Write-Host "Download folder already exists."
            }

            # Fetch the artifact upload URL
            Write-Host "Fetching the artifact upload URL..."
            $artifactUrl = (Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/artifacts" -Headers $headers).artifacts[0].archive_download_url
            if ($artifactUrl) {
                Write-Host "Artifact URL successfully fetched: $artifactUrl"
            } else {
                Write-Error "Failed to fetch the artifact URL."
                exit 1
            }

            # Download the artifact (zipped file)
            Write-Host "Starting artifact download..."
            $artifactZipPath = "$env:TEMP\artifact.zip"
            try {
                Invoke-WebRequest -Uri $artifactUrl `
                    -Headers $headers `
                    -OutFile $artifactZipPath `
                    -MaximumRedirection 5
                Write-Host "Artifact downloaded successfully to $artifactZipPath"
            } catch {
                Write-Error "Error downloading artifact: $_"
                exit 1
            }

            # Unzip the artifact
            $artifactUnzipPath = "$env:TEMP\artifact"
            Write-Host "Unzipping the artifact to $artifactUnzipPath..."
            try {
                Expand-Archive -Path $artifactZipPath -DestinationPath $artifactUnzipPath -Force
                Write-Host "Artifact unzipped successfully to $artifactUnzipPath"
            } catch {
                Write-Error "Failed to unzip the artifact: $_"
                exit 1
            }

            # Find the installer or app executable
            $artifactInstallerPath = Get-ChildItem -Path $artifactUnzipPath -Filter *.exe -Recurse | Select-Object -First 1
            if ($artifactInstallerPath) {
                Write-Host "Executable file found: $($artifactInstallerPath.FullName)"
            } else {
                Write-Error "Executable file not found. Exiting."
                exit 1
            }

            # Run the app directly instead of an installer
            Write-Host "Launching the Tauri API Example App: $($artifactInstallerPath.FullName)..."
            try {
                Start-Process -FilePath $artifactInstallerPath.FullName
                Write-Host "Application launched."
            } catch {
                Write-Error "Failed to run the application: $_"
                exit 1
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FORCE_COLOR: "3"
